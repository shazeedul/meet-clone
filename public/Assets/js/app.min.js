var AppProcess=function(){var local_div,serverProcess,audio,videoCamTrack,peers_connection_ids=[],peers_connection=[],remote_vid_stream=[],remote_aud_stream=[],isAudioMute=!0,rtp_aud_senders=[],video_states={None:0,Camera:1,ScreenShare:2},video_st=video_states.None,rtp_vid_senders=[],iceConfiguration={iceServers:[{urls:"stun:stun.l.google.com:19302"},{urls:"turn:128.199.213.61:3478",username:"shazeedul",credential:"321456"}]};async function _init(SDP_function,my_connect_id){serverProcess=SDP_function,my_connection_id=my_connect_id,$("#miceMuteUnmute").on("click",(async function(){audio||await async function(){try{var c_stream=await navigator.mediaDevices.getUserMedia({video:!1,audio:!0});(audio=c_stream.getAudioTracks()[0]).enabled=!1}catch(e){console.log(e)}}(),audio?(isAudioMute?(audio.enabled=!0,$(this).html("<span class='material-icons' style='width:100%;'>mic</span>"),updateMediaSenders(audio,rtp_aud_senders),console.log(rtp_aud_senders)):(audio.enabled=!1,$(this).html("<span class='material-icons' style='width:100%;'>mic_off</span>"),removeMediaSenders(rtp_aud_senders),audio.stop(),console.log(rtp_aud_senders)),isAudioMute=!isAudioMute):alert("Audio permission has not granted")})),$("#videoCamOnOff").on("click",(async function(){video_st==video_states.Camera?await videoProcess(video_states.None):await videoProcess(video_states.Camera)})),$("#ScreenShareOnOf").on("click",(async function(){video_st==video_states.ScreenShare?await videoProcess(video_states.None):await videoProcess(video_states.ScreenShare)})),local_div=document.getElementById("localVideoPlayer")}function connection_status(connection){return!(!connection||"new"!=connection.connectionState&&"connecting"!=connection.connectionState&&"connected"!=connection.connectionState)}async function updateMediaSenders(track,rtp_senders){for(var con_id in peers_connection_ids)connection_status(peers_connection[con_id])&&(rtp_senders[con_id]&&rtp_senders[con_id].track?rtp_senders[con_id].replaceTrack(track):rtp_senders[con_id]=peers_connection[con_id].addTrack(track))}function removeMediaSenders(rtp_senders){for(var con_id in console.log("rtp_senders :",rtp_senders),peers_connection_ids)rtp_senders[con_id]&&connection_status(peers_connection[con_id])&&(peers_connection[con_id].removeTrack(rtp_senders[con_id]),rtp_senders[con_id]=null)}function removeVideoStream(rtp_vid_senders){videoCamTrack&&(videoCamTrack.stop(),videoCamTrack=null,local_div.srcObject=null,removeMediaSenders(rtp_vid_senders))}async function videoProcess(newVideoState){if(newVideoState==video_states.None)return $("#videoCamOnOff").html("<span class='material-icons' style='width:100%;'>videocam_off</span>"),$("#ScreenShareOnOf").html('<span class="material-icons">present_to_all</span><div>Present Now</div>'),video_st=newVideoState,removeVideoStream(rtp_vid_senders),console.log("rtp_vid_senders",rtp_vid_senders),void serverProcess(JSON.stringify({Video_switch_off:"Video_switch_off"}),rtp_vid_senders);newVideoState==video_states.Camera&&$("#videoCamOnOff").html("<span class='material-icons' style='width:100%;'>videocam_on</span>");try{var vstream=null;newVideoState==video_states.Camera?vstream=await navigator.mediaDevices.getUserMedia({video:{width:1920,height:1080},audio:!1}):newVideoState==video_states.ScreenShare&&((vstream=await navigator.mediaDevices.getDisplayMedia({video:{width:1920,height:1080},audio:!1})).oninactive=e=>{removeVideoStream(rtp_vid_senders),$("#ScreenShareOnOf").html('<span class="material-icons ">present_to_all</span><div >Present Now</div>')}),vstream&&vstream.getVideoTracks().length>0&&(videoCamTrack=vstream.getVideoTracks()[0])&&(local_div.srcObject=new Medic_stream([videoCamTrack]),updateMediaSenders(videoCamTrack,rtp_vid_senders))}catch(e){return void console.log(e)}video_st=newVideoState,newVideoState==video_states.Camera?($("#videoCamOnOff").html('<span class="material-icons" style="width: 100%;">videocam</span>'),$("#ScreenShareOnOf").html('<span class="material-icons ">present_to_all</span><div >Present Now</div>')):newVideoState==video_states.ScreenShare&&($("#videoCamOnOff").html('<span class="material-icons" style="width: 100%;">videocam_off</span>'),$("#ScreenShareOnOf").html('<span class="material-icons text-success">present_to_all</span><div class="text-success">Stop Present Now</div>'))}async function setConnection(conn_id){var connection=new RTCPeerConnection(iceConfiguration);return connection.onnegotiationneeded=async function(event){await async function(conn_id){var connection=peers_connection[conn_id],offer=await connection.createOffer();await connection.setLocalDescription(offer),serverProcess(JSON.stringify({offer:connection.localDescription}),conn_id)}(conn_id)},connection.onicecandidate=function(event){event.candidate&&serverProcess(JSON.stringify({icecandidate:event.candidate}),conn_id)},connection.ontrack=function(event){if(remote_vid_stream[conn_id]||(remote_vid_stream[conn_id]=new Medic_stream),remote_aud_stream[conn_id]||(remote_aud_stream[conn_id]=new Medic_stream),"video"==event.track.kind){remote_vid_stream[conn_id].getVideoTracks().forEach((t=>remote_vid_stream[conn_id].removeTrack(t))),remote_vid_stream[conn_id].addTrack(event.track);var remoteVideoPlayer=document.getElementById("v_"+conn_id);remoteVideoPlayer.srcObject=null,remoteVideoPlayer.srcObject=remote_vid_stream[conn_id],remoteVideoPlayer.load()}else if("audio"==event.track.kind){remote_aud_stream[conn_id].getAudioTracks().forEach((t=>remote_aud_stream[conn_id].removeTrack(t))),remote_aud_stream[conn_id].addTrack(event.track);var remoteAudioPlayer=document.getElementById("a_"+conn_id);remoteAudioPlayer.srcObject=null,remoteAudioPlayer.srcObject=remote_aud_stream[conn_id],remoteAudioPlayer.load()}},peers_connection_ids[conn_id]=conn_id,peers_connection[conn_id]=connection,video_st!=video_states.Camera&&video_st!=video_states.ScreenShare||videoCamTrack&&updateMediaSenders(videoCamTrack,rtp_vid_senders),connection}return{setNewConnection:async function(conn_id){await setConnection(conn_id)},init:async function(SDP_function,my_connect_id){await _init(SDP_function,my_connect_id)},processClientFunc:async function(data,from_conn_id){await async function(message,from_conn_id){if((message=JSON.parse(message)).answer)await peers_connection[from_conn_id].setRemoteDescription(new RTCSessionDescription(message.answer));else if(message.offer){peers_connection[from_conn_id]||await setConnection(from_conn_id),await peers_connection[from_conn_id].setRemoteDescription(new RTCSessionDescription(message.offer));var answer=await peers_connection[from_conn_id].createAnswer();await peers_connection[from_conn_id].setLocalDescription(answer),serverProcess(JSON.stringify({answer:answer}),from_conn_id)}else if(message.icecandidate){peers_connection[from_conn_id]||await setConnection(from_conn_id);try{await peers_connection[from_conn_id].addIceCandidate(message.icecandidate)}catch(e){console.log(e)}}else message.Video_switch_off&&(document.querySelector("#v_"+from_conn_id).srcObject=null)}(data,from_conn_id)},closeConnectionCall:async function(conn_id){await async function(conn_id){peers_connection_ids[conn_id]=null,peers_connection[conn_id]&&(peers_connection[conn_id].close(),peers_connection[conn_id]=null),remote_aud_stream[conn_id]&&(remote_aud_stream[conn_id].getTracks().forEach((t=>{t.stop&&t.stop()})),remote_aud_stream[conn_id]=null),remote_vid_stream[conn_id]&&(remote_vid_stream[conn_id].getTracks().forEach((t=>{t.stop&&t.stop()})),remote_vid_stream[conn_id]=null)}(conn_id)}}}(),MyApp=function(){var socket=null,user_id="",meeting_id="";function init(uid,mid){user_id=uid,meeting_id=mid,$("#meetingContainer").show(),$("#me h2").text(user_id+"(Me)"),document.title=user_id,function(){socket=io.connect();var SDP_function=function(data,to_conn_id){socket.emit("SDPProcess",{message:data,to_conn_id:to_conn_id})};socket.on("connect",(()=>{socket.connected&&(AppProcess.init(SDP_function,socket.id),""!=user_id&&""!=meeting_id&&socket.emit("userconnect",{displayName:user_id,meetingid:meeting_id}))})),socket.on("inform_other_about_disconnected_user",(function(data){$("#"+data.connId).remove(),$(".participant-count").text(data.uNumber),$("#participant_"+data.connId).remove(),AppProcess.closeConnectionCall(data.connId)})),socket.on("HandRaise_info_for_others",(function(data){data.handRaise?$("#hand_"+data.connId).show():$("#hand_"+data.connId).hide()})),socket.on("inform_others_about_me",(function(data){addUser(data.other_user_id,data.connId,data.userNumber),AppProcess.setNewConnection(data.connId)})),socket.on("showFileMessage",(function(data){var mar_top="-"+(135+10*$(".left-align").length);$(".g-details").css({"margin-top":mar_top});(new Date).toLocaleString("en-US",{hour:"numeric",minute:"numeric",hour12:!0});document.querySelector(".show-attach-file").innerHTML+="<div class='left-align' style='display:flex; align-items:center;'><img src='public/assets/images/other.jpg' style='height:40px;width:40px;' class='caller-image circle'><div style='font-weight:600;margin:0 5px;'>"+data.username+"</div>:<div><a style='color:#007bff;' href='"+data.filePath+"' download>"+data.fileName+"</a></div></div><br/>"})),socket.on("inform_me_about_other_user",(function(other_users){var userNumb=other_users.length+1;if(other_users)for(var i=0;i<other_users.length;i++)addUser(other_users[i].user_id,other_users[i].connectionId,userNumb),AppProcess.setNewConnection(other_users[i].connectionId)})),socket.on("SDPProcess",(async function(data){await AppProcess.processClientFunc(data.message,data.from_conn_id)})),socket.on("showChatMessage",(function(data){var lTime=(new Date).toLocaleString("en-US",{hour:"numeric",minute:"numeric",hour12:!0}),div=$("<div>").html("<span class='font-weight-bold mr-3' style='color:black'>"+data.from+"</span>"+lTime+"</br>"+data.message);$("#messages").append(div)}))}(),function(){var handRaise=!1;$("#handRaiseAction").on("click",(async function(){handRaise?($("img.handRaise").hide(),handRaise=!1,socket.emit("sendHandRaise",handRaise)):($("img.handRaise").show(),handRaise=!0,socket.emit("sendHandRaise",handRaise))})),$("#btnSend").on("click",(function(){var msgData=$("#msgBox").val();socket.emit("sendMessage",msgData);var lTime=(new Date).toLocaleString("en-US",{hour:"numeric",minute:"numeric",hour12:!0}),div=$("<div>").html("<span class='font-weight-bold mr-3' style='color:black'>"+user_id+"</span>"+lTime+"</br>"+msgData);$("#messages").append(div),$("#msgBox").val("")}));var url=window.location.href;$(".meeting_url").text(url),$("#divUsers").on("dblclick","video",(function(){this.requestFullscreen()}))}()}function addUser(other_user_id,connId,userNum){var newDivId=$("#otherTemplate").clone();(newDivId=newDivId.attr("id",connId).addClass("other")).find("h2").text(other_user_id),newDivId.find("video").attr("id","v_"+connId),newDivId.find("audio").attr("id","a_"+connId),newDivId.find("img").attr("id","hand_"+connId),newDivId.show(),$("#divUsers").append(newDivId),$(".in-call-wrap-up").append('<div class="in-call-wrap d-flex justify-content-between align-items-center mb-3" id="participant_'+connId+'"> <div class="participant-img-name-wrap display-center cursor-pointer"> <div class="participant-img"> <img src="public/Assets/images/other.jpg" alt="" class="border border-secondary" style="height: 40px;width: 40px;border-radius: 50%;"> </div> <div class="participant-name ml-2"> '+other_user_id+'</div> </div> <div class="participant-action-wrap display-center"> <div class="participant-action-dot display-center mr-2 cursor-pointer"> <span class="material-icons"> more_vert </span> </div> <div class="participant-action-pin display-center mr-2 cursor-pointer"> <span class="material-icons"> push_pin </span> </div> </div> </div>'),$(".participant-count").text(userNum)}$(document).on("click",".people-heading",(function(){$(".in-call-wrap-up").show(300),$(".chat-show-wrap").hide(300),$(this).addClass("active"),$(".chat-heading").removeClass("active")})),$(document).on("click",".chat-heading",(function(){$(".in-call-wrap-up").hide(300),$(".chat-show-wrap").show(300),$(this).addClass("active"),$(".people-heading").removeClass("active")})),$(document).on("click",".meeting-heading-cross",(function(){$(".g-right-details-wrap").hide(300)})),$(document).on("click",".top-left-participant-wrap",(function(){$(".people-heading").addClass("active"),$(".chat-heading").removeClass("active"),$(".g-right-details-wrap").show(300),$(".in-call-wrap-up").show(300),$(".chat-show-wrap").hide(300)})),$(document).on("click",".top-left-chat-wrap",(function(){$(".people-heading").removeClass("active"),$(".chat-heading").addClass("active"),$(".g-right-details-wrap").show(300),$(".in-call-wrap-up").hide(300),$(".chat-show-wrap").show(300)})),$(document).on("click",".end-call-wrap",(function(){$(".top-box-show").css({display:"block"}).html('<div class="top-box align-vertical-middle profile-dialogue-show"> <h4 class="mt-3" style="text-align:center;color:white;">Leave Meeting</h4> <hr> <div class="call-leave-cancel-action d-flex justify-content-center align-items-center w-100"> <a href="/action.html"><button class="call-leave-action btn btn-danger mr-5">Leave</button></a> <button class="call-cancel-action btn btn-secondary">Cancel</button> </div> </div>')})),$(document).mouseup((function(e){var container=new Array;container.push($(".top-box-show")),$.each(container,(function(key,value){$(value).is(e.target)||0!=$(value).has(e.target).length||$(value).empty()}))})),$(document).mouseup((function(e){var container=new Array;container.push($(".g-details")),container.push($(".g-right-details-wrap")),$.each(container,(function(key,value){$(value).is(e.target)||0!=$(value).has(e.target).length||$(value).hide(300)}))})),$(document).on("click",".call-cancel-action",(function(){$(".top-box-show").html("")})),$(document).on("click",".copy_info",(function(){var $temp=$("<input>");$("body").append($temp),$temp.val($(".meeting_url").text()).select(),document.execCommand("copy"),$temp.remove(),$(".link-conf").show(),setTimeout((function(){$(".link-conf").hide()}),3e3)})),$(document).on("click",".meeting-details-button",(function(){$(".g-details").slideDown(300)})),$(document).on("click",".g-details-heading-attachment",(function(){$(".g-details-heading-show").hide(),$(".g-details-heading-show-attachment").show(),$(this).addClass("active"),$(".g-details-heading-detail").removeClass("active")})),$(document).on("click",".g-details-heading-detail",(function(){$(".g-details-heading-show").show(),$(".g-details-heading-show-attachment").hide(),$(this).addClass("active"),$(".g-details-heading-attachment").removeClass("active")}));var base_url=window.location.origin;$(document).on("change",".custom-file-input",(function(){var fileName=$(this).val().split("\\").pop();$(this).siblings(".custom-file-label").addClass("selected").html(fileName)})),$(document).on("click",".share-attach",(function(e){e.preventDefault();var att_img=$("#customFile").prop("files")[0],formData=new FormData;formData.append("zipFile",att_img),formData.append("meeting_id",meeting_id),formData.append("username",user_id),console.log(formData),$.ajax({url:base_url+"/attaching",type:"POST",data:formData,contentType:!1,processData:!1,success:function(response){console.log(response)},error:function(){console.log("error")}});var attachFileArea=document.querySelector(".show-attach-file"),attachFileName=$("#customFile").val().split("\\").pop(),attachFilePath="public/attachment/"+meeting_id+"/"+attachFileName;attachFileArea.innerHTML+="<div class='left-align' style='display:flex; align-items:center;'><img src='public/assets/images/other.jpg' style='height:40px;width:40px;' class='caller-image circle'><div style='font-weight:600;margin:0 5px;'>"+user_id+"</div>:<div><a style='color:#007bff;' href='"+attachFilePath+"' download>"+attachFileName+"</a></div></div><br/>",$("label.custom-file-label").text(""),socket.emit("fileTransferToOther",{username:user_id,meetingid:meeting_id,filePath:attachFilePath,fileName:attachFileName})})),$(document).on("click",".option-icon",(function(){$(".recording-show").toggle(300)})),$(document).on("click",".start-record",(function(){$(this).removeClass().addClass("stop-record btn-danger text-dark").text("Stop Recording"),async function(){const screenStream=await async function(mediaContent={video:!0}){const screenStream=await navigator.mediaDevices.getDisplayMedia(mediaContent);return screenStream}(),audioStream=await async function(mediaContent={video:!1,audio:!0}){const audioStream=await navigator.mediaDevices.getUserMedia(mediaContent);return audioStream}(),stream=new Medic_stream([...screenStream.getTracks(),...audioStream.getTracks()]);(mediaRecorder=new MediaRecorder(stream)).start(),mediaRecorder.onstop=function(e){var clipName=prompt("Enter a name for your recording");stream.getTracks().forEach((track=>track.stop()));const blob=new Blob(chunks,{type:"video/webm"}),url=window.URL.createObjectURL(blob),a=document.createElement("a");a.style.display="none",a.href=url,a.download=clipName+".webm",document.body.appendChild(a),a.click(),setTimeout((()=>{document.body.removeChild(a),window.URL.revokeObjectURL(url)}),100)},mediaRecorder.ondataavailable=function(e){chunks.push(e.data)}}()})),$(document).on("click",".stop-record",(function(){$(this).removeClass().addClass("start-record btn-dark text-danger").text("Start Recording"),mediaRecorder.stop()}));var mediaRecorder,chunks=[];return{_init:function(uid,mid){init(uid,mid)}}}();